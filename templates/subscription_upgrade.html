<!-- Plan Yükseltme Modal -->
<div class="modal fade" id="upgradePlanModal" tabindex="-1" aria-labelledby="upgradePlanModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="upgradePlanModalLabel">
                    <i class="fas fa-crown text-warning"></i> Abonelik Planını Yükselt
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Mevcut Plan Bilgisi -->
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> Mevcut Planınız</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Plan:</strong> <span id="current-plan-name">--</span><br>
                            <strong>Kamera Limiti:</strong> <span id="current-camera-limit">--</span><br>
                            <strong>Kullanım:</strong> <span id="current-usage">--</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Durum:</strong> <span id="current-status">--</span><br>
                            <strong>Bitiş Tarihi:</strong> <span id="current-end-date">--</span><br>
                            <strong>Kalan Gün:</strong> <span id="current-days-remaining">--</span>
                        </div>
                    </div>
                </div>

                <!-- Plan Seçenekleri -->
                <h6 class="mb-3"><i class="fas fa-list"></i> Mevcut Planlar</h6>
                <div class="row">
                    <!-- Starter Plan -->
                    <div class="col-md-4 mb-3">
                        <div class="card plan-card" data-plan="starter">
                            <div class="card-header text-center">
                                <h6 class="mb-0"><i class="fas fa-rocket"></i> Starter</h6>
                            </div>
                            <div class="card-body text-center">
                                <h4 class="text-primary">$99<span class="text-muted">/ay</span></h4>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-video"></i> 5 Kamera</li>
                                    <li><i class="fas fa-shield-alt"></i> Temel Güvenlik</li>
                                    <li><i class="fas fa-headset"></i> Email Destek</li>
                                    <li><i class="fas fa-chart-bar"></i> Temel Raporlar</li>
                                </ul>
                                <button class="btn btn-outline-primary btn-sm w-100" onclick="selectPlan('starter')">
                                    Seç
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Professional Plan -->
                    <div class="col-md-4 mb-3">
                        <div class="card plan-card" data-plan="professional">
                            <div class="card-header text-center bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-star"></i> Professional</h6>
                            </div>
                            <div class="card-body text-center">
                                <h4 class="text-warning">$299<span class="text-muted">/ay</span></h4>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-video"></i> 15 Kamera</li>
                                    <li><i class="fas fa-shield-alt"></i> Gelişmiş Güvenlik</li>
                                    <li><i class="fas fa-headset"></i> 7/24 Destek</li>
                                    <li><i class="fas fa-chart-line"></i> Detaylı Analitik</li>
                                    <li><i class="fas fa-bell"></i> Gelişmiş Bildirimler</li>
                                </ul>
                                <button class="btn btn-warning btn-sm w-100" onclick="selectPlan('professional')">
                                    Seç
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Enterprise Plan -->
                    <div class="col-md-4 mb-3">
                        <div class="card plan-card" data-plan="enterprise">
                            <div class="card-header text-center bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-crown"></i> Enterprise</h6>
                            </div>
                            <div class="card-body text-center">
                                <h4 class="text-success">$599<span class="text-muted">/ay</span></h4>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-video"></i> 50 Kamera</li>
                                    <li><i class="fas fa-shield-alt"></i> Maksimum Güvenlik</li>
                                    <li><i class="fas fa-headset"></i> Öncelikli Destek</li>
                                    <li><i class="fas fa-chart-pie"></i> Özel Raporlar</li>
                                    <li><i class="fas fa-cogs"></i> API Erişimi</li>
                                    <li><i class="fas fa-users"></i> Çoklu Kullanıcı</li>
                                </ul>
                                <button class="btn btn-success btn-sm w-100" onclick="selectPlan('enterprise')">
                                    Seç
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seçilen Plan Detayları -->
                <div id="selected-plan-details" class="alert alert-success" style="display: none;">
                    <h6><i class="fas fa-check-circle"></i> Seçilen Plan</h6>
                    <div id="plan-details-content"></div>
                </div>

                <!-- Plan Değişiklik Uyarısı -->
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle"></i> Önemli Bilgiler</h6>
                    <ul class="mb-0">
                        <li>Plan değişikliği anında aktif olur</li>
                        <li>Mevcut kameralarınız korunur</li>
                        <li>Yeni limitler hemen uygulanır</li>
                        <li>Fatura döneminiz değişmez</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> İptal
                </button>
                <button type="button" class="btn btn-primary" id="confirm-upgrade-btn" onclick="confirmPlanUpgrade()" disabled>
                    <i class="fas fa-check"></i> Planı Değiştir
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.plan-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
    cursor: pointer;
}

.plan-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}

.plan-card.selected {
    border-color: #007bff;
    box-shadow: 0 0 20px rgba(0,123,255,0.3);
}

.plan-card .card-header {
    font-weight: bold;
}

.plan-card ul li {
    margin-bottom: 8px;
    font-size: 0.9em;
}

.plan-card ul li i {
    width: 20px;
    color: #6c757d;
}
</style>

<script>
let selectedPlan = null;
let currentPlan = null;

// Plan seçimi
function selectPlan(plan) {
    selectedPlan = plan;
    
    // Tüm kartlardan seçim işaretini kaldır
    document.querySelectorAll('.plan-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Seçilen kartı işaretle
    document.querySelector(`[data-plan="${plan}"]`).classList.add('selected');
    
    // Plan detaylarını göster
    showPlanDetails(plan);
    
    // Onay butonunu aktif et
    document.getElementById('confirm-upgrade-btn').disabled = false;
}

// Plan detaylarını göster
function showPlanDetails(plan) {
    const planDetails = {
        'starter': {
            name: 'Starter',
            price: '$99/ay',
            cameras: '5 Kamera',
            features: ['Temel Güvenlik', 'Email Destek', 'Temel Raporlar']
        },
        'professional': {
            name: 'Professional',
            price: '$299/ay',
            cameras: '15 Kamera',
            features: ['Gelişmiş Güvenlik', '7/24 Destek', 'Detaylı Analitik', 'Gelişmiş Bildirimler']
        },
        'enterprise': {
            name: 'Enterprise',
            price: '$599/ay',
            cameras: '50 Kamera',
            features: ['Maksimum Güvenlik', 'Öncelikli Destek', 'Özel Raporlar', 'API Erişimi', 'Çoklu Kullanıcı']
        }
    };
    
    const details = planDetails[plan];
    const detailsDiv = document.getElementById('plan-details-content');
    
    detailsDiv.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <strong>Plan:</strong> ${details.name}<br>
                <strong>Fiyat:</strong> ${details.price}<br>
                <strong>Kamera Limiti:</strong> ${details.cameras}
            </div>
            <div class="col-md-6">
                <strong>Özellikler:</strong><br>
                ${details.features.map(feature => `<i class="fas fa-check text-success"></i> ${feature}`).join('<br>')}
            </div>
        </div>
    `;
    
    document.getElementById('selected-plan-details').style.display = 'block';
}

// Plan yükseltmeyi onayla
function confirmPlanUpgrade() {
    if (!selectedPlan) {
        alert('❌ Lütfen bir plan seçin!');
        return;
    }
    
    if (selectedPlan === currentPlan) {
        alert('❌ Zaten bu plandasınız!');
        return;
    }
    
    if (confirm(`⚠️ ${selectedPlan.toUpperCase()} planına geçmek istediğinizden emin misiniz?`)) {
        // Plan değiştirme API'sini çağır
        fetch(`/api/company/${companyId}/subscription/change-plan`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({new_plan: selectedPlan})
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('✅ Plan başarıyla değiştirildi!');
                
                // Modal'ı kapat
                const modal = bootstrap.Modal.getInstance(document.getElementById('upgradePlanModal'));
                modal.hide();
                
                // Abonelik bilgilerini yenile
                if (typeof loadSubscriptionInfo === 'function') {
                    loadSubscriptionInfo();
                }
                
                // Sayfayı yenile
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                alert('❌ Hata: ' + result.error);
            }
        })
        .catch(error => {
            console.error('Plan değiştirme hatası:', error);
            alert('❌ Plan değiştirme sırasında bir hata oluştu!');
        });
    }
}

// Modal açıldığında mevcut plan bilgilerini yükle
document.addEventListener('DOMContentLoaded', function() {
    const upgradeModal = document.getElementById('upgradePlanModal');
    if (upgradeModal) {
        upgradeModal.addEventListener('show.bs.modal', function() {
            // Mevcut plan bilgilerini yükle
            loadCurrentPlanInfo();
        });
    }
});

// Mevcut plan bilgilerini yükle
function loadCurrentPlanInfo() {
    fetch(`/api/company/${companyId}/subscription`)
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            const subscription = result.subscription;
            currentPlan = subscription.subscription_type;
            
            // Mevcut plan bilgilerini göster
            document.getElementById('current-plan-name').textContent = subscription.subscription_type.toUpperCase();
            document.getElementById('current-camera-limit').textContent = subscription.max_cameras;
            document.getElementById('current-usage').textContent = `${subscription.used_cameras}/${subscription.max_cameras}`;
            document.getElementById('current-status').textContent = subscription.is_active ? 'Aktif' : 'Süresi Dolmuş';
            document.getElementById('current-end-date').textContent = subscription.subscription_end ? new Date(subscription.subscription_end).toLocaleDateString('tr-TR') : '--';
            document.getElementById('current-days-remaining').textContent = subscription.days_remaining || '--';
            
            // Mevcut planı seçili göster
            selectPlan(currentPlan);
        }
    })
    .catch(error => {
        console.error('Mevcut plan bilgileri yükleme hatası:', error);
    });
}
</script> 